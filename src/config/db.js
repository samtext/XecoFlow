import { supabase, supabaseAdmin } from './supabase.js';
import { DB_MAPPING } from './systemRules.js'; 

/**
 * BIG-SYSTEM-V1.2 | DATABASE MANAGER
 * Single source of truth for table access.
 */
export const db = {
    /**
     * âœ… FIX: Standardizes access to prevent "db.from is not a function" errors
     * Uses supabaseAdmin as the primary engine for server-side logic.
     * Added a safety check to ensure tableName is provided.
     */
    from: (tableName) => {
        if (!tableName) {
            console.error("âŒ DB_ERROR: Table name is undefined in db.from call");
            return null;
        }
        return supabaseAdmin.from(tableName);
    },

    /**
     * âœ… UPDATED: Guest-Ready Transaction Helper
     * Uses supabaseAdmin to bypass RLS. This allows the system to save
     * transactions even if the user_id is a "Guest ID" generated by the frontend.
     */
    airtime_transactions: () => supabaseAdmin.from(DB_MAPPING.TABLES.TRANSACTIONS),

    /**
     * âœ… FIXED: Explicit helper for callback logging
     * Safaricom's callback has no user context, so we MUST use Admin.
     */
    mpesa_callback_logs: () => supabaseAdmin.from('mpesa_callback_logs'),

    // Legacy mapping support (if still used in other files)
    mpesa_logs: () => supabaseAdmin.from(DB_MAPPING.TABLES.MPESA_LOGS),

    /**
     * âœ… NOTE: Standard mappings for Client-Side (Public)
     * These use the standard 'supabase' client which respects RLS.
     * Useful for fetching data that the public is allowed to see.
     */
    transactions: () => supabase.from(DB_MAPPING.TABLES.TRANSACTIONS),
    disbursements: () => supabase.from(DB_MAPPING.TABLES.DISBURSEMENTS),

    // Administrative mappings
    idempotency: () => supabaseAdmin.from(DB_MAPPING.TABLES.IDEMPOTENCY),
    provider_logs: () => supabaseAdmin.from(DB_MAPPING.TABLES.PROVIDER_LOGS),
    ledger: () => supabaseAdmin.from(DB_MAPPING.TABLES.FLOAT_LEDGER),
    health: () => supabaseAdmin.from(DB_MAPPING.TABLES.SYSTEM_HEALTH)
};

// Log operational status to help debug Render deployments
console.log("ðŸš€ XECO-ENGINE: Database Abstraction Layer Operational (Guest Support Active).");